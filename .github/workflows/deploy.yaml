name: Deploy Arch Wiki Mirror
on:
  schedule:
    - cron: "27 3 4 * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd pacman-package-manager

      - name: Configure Pacman
        run: |
          # Create a local directory for the pacman database
          mkdir -p ./arch-root/var/lib/pacman
          
          # Generate a minimal pacman.conf
          # SigLevel is set to Never to avoid GPG keyring setup issues
          cat <<EOF > ./pacman.conf
          [options]
          DBPath = $(pwd)/arch-root/var/lib/pacman
          Architecture = x86_64
          SigLevel = Never
          RemoteFileSigLevel = Never

          [core]
          Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch
          [extra]
          Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch
          EOF

      - name: Download Wiki Archive
        run: |
          # -Sy: Sync databases
          # -Sw: Download only (do not install)
          # --cachedir .: Save the file to the current working directory
          sudo pacman --config ./pacman.conf -Sy
          sudo pacman --config ./pacman.conf --cachedir . -Sw arch-wiki-docs --noconfirm --dbonly
          
          # Rename the downloaded file to a standard name for the next step
          find . -name "arch-wiki-docs-*.pkg.tar.zst" -exec mv {} wiki.tar.zst \;
          ls -lh wiki.tar.zst

      - name: Create Upload Root
        run: |
          mkdir -p build
          mkdir -p public
          tar -I zstd -xf wiki.tar.zst -C build
          cp -rn build/usr/share/doc/arch-wiki/html/* public/

      - name: Merge Repository Additions
        run: |
          if [ -d "src" ]; then
            echo "Source directory 'src' found. Merging additions..."
            cp -rv src/* public/
          else
            echo "Source directory 'src' not found. Skipping merge."
          fi

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
